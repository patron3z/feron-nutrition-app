{"fsPath":"\\home\\user\\workspace\\src\\api\\nutrition-ai.ts","fileUuid":"f943ecfd-f874-4c7d-937b-bac7097a6147","fileSizeBytes":25519,"numLines":662,"diffChanges":[{"originalStartLineNumberOneIndexed":1,"originalEndLineNumberExclusiveOneIndexed":2,"modifiedStartLineNumberOneIndexed":1,"modifiedEndLineNumberExclusiveOneIndexed":2,"addedLines":["import { analyzeNutritionImage, estimateNutritionWithReplicate } from \"./replicate\";"],"tokenizedAddedLines":[1000453]},{"originalStartLineNumberOneIndexed":242,"originalEndLineNumberExclusiveOneIndexed":243,"modifiedStartLineNumberOneIndexed":242,"modifiedEndLineNumberExclusiveOneIndexed":243,"addedLines":[" * Enhanced food analysis using USDA + Replicate GPT-4.1-mini with portion scale detection"],"tokenizedAddedLines":[1000454]},{"originalStartLineNumberOneIndexed":244,"originalEndLineNumberExclusiveOneIndexed":246,"modifiedStartLineNumberOneIndexed":244,"modifiedEndLineNumberExclusiveOneIndexed":246,"addedLines":["export const analyzeFoodWithUSDAAndReplicate = async (imageBase64?: string, description?: string): Promise<NutritionAnalysisResult> => {","  console.log('üîç Analyse avanc√©e avec USDA + Replicate GPT-4.1-mini + Scale...');"],"tokenizedAddedLines":[1000455,1000456]},{"originalStartLineNumberOneIndexed":248,"originalEndLineNumberExclusiveOneIndexed":250,"modifiedStartLineNumberOneIndexed":248,"modifiedEndLineNumberExclusiveOneIndexed":249,"addedLines":["    // Step 1: Use Replicate GPT-4.1-mini to identify foods AND estimate portion scales"],"tokenizedAddedLines":[1000457]},{"originalStartLineNumberOneIndexed":288,"originalEndLineNumberExclusiveOneIndexed":290,"modifiedStartLineNumberOneIndexed":287,"modifiedEndLineNumberExclusiveOneIndexed":292,"addedLines":["    const replicateResponse = imageBase64 ","      ? await analyzeNutritionImage(imageBase64)","      : await analyzeNutritionImage('data:text/plain,' + encodeURIComponent(identificationPrompt));","    ","    const cleanResponse = (replicateResponse || \"\")"],"tokenizedAddedLines":[1000458,1000459,1000460,137,1000461]},{"originalStartLineNumberOneIndexed":293,"originalEndLineNumberExclusiveOneIndexed":294,"modifiedStartLineNumberOneIndexed":295,"modifiedEndLineNumberExclusiveOneIndexed":296,"addedLines":["    console.log('ü§ñ Replicate GPT-4.1-mini identification avec scale:', cleanResponse);"],"tokenizedAddedLines":[1000462]},{"originalStartLineNumberOneIndexed":296,"originalEndLineNumberExclusiveOneIndexed":300,"modifiedStartLineNumberOneIndexed":298,"modifiedEndLineNumberExclusiveOneIndexed":302,"addedLines":["    if (cleanResponse.toLowerCase().includes('no food') || ","        cleanResponse.toLowerCase().includes('pas de nourriture') ||","        cleanResponse.toLowerCase().includes('cannot identify')) {","      console.warn('‚ö†Ô∏è Replicate ne d√©tecte pas de nourriture dans l\\'image');"],"tokenizedAddedLines":[1000463,1000464,1000465,1000466]},{"originalStartLineNumberOneIndexed":303,"originalEndLineNumberExclusiveOneIndexed":305,"modifiedStartLineNumberOneIndexed":305,"modifiedEndLineNumberExclusiveOneIndexed":307,"addedLines":["    // Step 2: Parse Replicate response to extract foods and scales","    const lines = cleanResponse.split('\\n')"],"tokenizedAddedLines":[1000467,1000468]},{"originalStartLineNumberOneIndexed":429,"originalEndLineNumberExclusiveOneIndexed":432,"modifiedStartLineNumberOneIndexed":431,"modifiedEndLineNumberExclusiveOneIndexed":433,"addedLines":["          // Fallback to Replicate estimation with scale","          console.log(`‚ö†Ô∏è Pas de donn√©es USDA pour ${foodName}, utilisation Replicate avec √©chelle ${scale}x`);"],"tokenizedAddedLines":[1000469,1000470]},{"originalStartLineNumberOneIndexed":434,"originalEndLineNumberExclusiveOneIndexed":437,"modifiedStartLineNumberOneIndexed":435,"modifiedEndLineNumberExclusiveOneIndexed":436,"addedLines":["            const nutritionData = await estimateNutritionWithReplicate(foodName);"],"tokenizedAddedLines":[1000471]},{"originalStartLineNumberOneIndexed":438,"originalEndLineNumberExclusiveOneIndexed":439,"modifiedStartLineNumberOneIndexed":437,"modifiedEndLineNumberExclusiveOneIndexed":438,"addedLines":["            // Utiliser les valeurs Replicate ou des valeurs par d√©faut am√©lior√©es"],"tokenizedAddedLines":[1000472]},{"originalStartLineNumberOneIndexed":445,"originalEndLineNumberExclusiveOneIndexed":446,"modifiedStartLineNumberOneIndexed":444,"modifiedEndLineNumberExclusiveOneIndexed":445,"addedLines":["              id: `replicate_${Date.now()}_${foodName.replace(/\\s+/g, '_')}_${scale}x`,"],"tokenizedAddedLines":[1000473]},{"originalStartLineNumberOneIndexed":455,"originalEndLineNumberExclusiveOneIndexed":456,"modifiedStartLineNumberOneIndexed":454,"modifiedEndLineNumberExclusiveOneIndexed":455,"addedLines":["              brand: \"Replicate GPT-4.1-mini\","],"tokenizedAddedLines":[1000474]},{"originalStartLineNumberOneIndexed":459,"originalEndLineNumberExclusiveOneIndexed":460,"modifiedStartLineNumberOneIndexed":458,"modifiedEndLineNumberExclusiveOneIndexed":459,"addedLines":["            console.log(`‚úÖ Replicate estimation avec √©chelle ${scale}x pour ${foodName}: ${(baseCalories * scale).toFixed(0)}kcal`);"],"tokenizedAddedLines":[1000475]},{"originalStartLineNumberOneIndexed":461,"originalEndLineNumberExclusiveOneIndexed":462,"modifiedStartLineNumberOneIndexed":460,"modifiedEndLineNumberExclusiveOneIndexed":461,"addedLines":["            console.warn('Erreur parsing Replicate nutrition, utilisation des valeurs par d√©faut am√©lior√©es:', parseError);"],"tokenizedAddedLines":[1000476]},{"originalStartLineNumberOneIndexed":515,"originalEndLineNumberExclusiveOneIndexed":516,"modifiedStartLineNumberOneIndexed":514,"modifiedEndLineNumberExclusiveOneIndexed":515,"addedLines":["        \"Donn√©es provenant de USDA et Replicate GPT-4.1-mini avec d√©tection d'√©chelle\","],"tokenizedAddedLines":[1000477]},{"originalStartLineNumberOneIndexed":524,"originalEndLineNumberExclusiveOneIndexed":525,"modifiedStartLineNumberOneIndexed":523,"modifiedEndLineNumberExclusiveOneIndexed":524,"addedLines":["    console.error('‚ùå Erreur analyse USDA + Replicate:', error);"],"tokenizedAddedLines":[1000478]}],"gitInfo":{"noRepoFound":true},"kind":"KIND_MODIFIED"}